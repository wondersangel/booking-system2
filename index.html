<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* 這裡包含了熱點圖與介面的樣式 */
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; display:flex; justify-content:center; align-items:center; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .calendar-day { border: 1px solid #ddd; padding: 5px; min-height: 80px; cursor: pointer; border-radius: 8px; font-size: 0.9em; transition: 0.2s;}
    .calendar-day:hover { transform: scale(1.03); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .calendar-day.selected { border: 2px solid #0d6efd; background-color: #e7f1ff; }
    .status-green { background-color: #d1e7dd; color: #0f5132; }
    .status-yellow { background-color: #fff3cd; color: #664d03; }
    .status-red { background-color: #f8d7da; color: #842029; }
    .status-gray { background-color: #f9f9f9; color: #ccc; pointer-events: none; }
    .slot-card { cursor: pointer; border: 1px solid #ddd; transition: 0.2s; }
    .slot-card:hover { background-color: #f8f9fa; }
    .slot-card.active { background-color: #0d6efd; color: white; border-color: #0d6efd; }
    .slot-card.disabled { background-color: #e9ecef; color: #999; pointer-events: none; opacity: 0.7; }
  </style>
</head>
<body>

<div id="loader" class="loading-overlay">
  <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
</div>

<div class="container py-4" style="max-width: 800px;">
  <h2 class="text-center mb-4">網上預約系統</h2>

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span id="currentMonthLabel" class="fw-bold">載入中...</span>
      <div style="font-size: 0.75rem;">
        <span class="badge bg-success me-1">綠:空閒</span>
        <span class="badge bg-warning text-dark me-1">黃:繁忙</span>
        <span class="badge bg-danger">紅:已滿</span>
      </div>
    </div>
    <div class="card-body">
      <div class="calendar-grid mb-2 text-center fw-bold text-muted small">
        <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
      </div>
      <div id="calendarContainer" class="calendar-grid"></div>
    </div>
  </div>

  <div id="bookingSection" class="row g-4" style="display:none;">
    
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">選擇時段 (<span id="selectedDateDisplay"></span>)</div>
        <div class="card-body">
          <div id="slotsContainer" class="row g-2"></div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card h-100 border-primary">
        <div class="card-header bg-primary text-white">填寫資料</div>
        <div class="card-body">
          <form id="bookingForm" onsubmit="event.preventDefault(); submitBooking();">
            <div class="mb-3">
              <label class="form-label small text-muted">已選時段</label>
              <input type="text" class="form-control" id="displayTime" disabled readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">預約人號碼 / ID <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="bookerId" placeholder="例如：會員編號" required>
            </div>
            <div class="d-grid">
              <button type="submit" id="submitBtn" class="btn btn-primary" disabled>確認預約</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // --- 系統設定 ---
  const CONFIG = {
    maxPerSlot: 3,
    timeSlots: ["09:00", "10:00", "11:00", "12:00", "14:00", "15:00", "16:00"],
    totalSlotsPerDay: 7 // 7個時段
  };

  let allBookings = [];
  let selectedDate = null;
  let selectedTime = null;

  // --- 初始化：從 Google Sheet 拉取資料 ---
  window.onload = function() {
    refreshData();
  };

  function refreshData() {
    document.getElementById('loader').style.display = 'flex';
    google.script.run
      .withSuccessHandler(function(data) {
        allBookings = data;
        renderCalendar();
        document.getElementById('loader').style.display = 'none';
        
        // 如果已經選了日期，刷新時段狀態 (防止停留在舊狀態)
        if(selectedDate) {
          renderSlots(selectedDate);
        }
      })
      .withFailureHandler(function(err){
        alert("讀取數據失敗：" + err);
        document.getElementById('loader').style.display = 'none';
      })
      .getBookingData();
  }

  // --- 1. 繪製日曆熱點圖 ---
  function renderCalendar() {
    const container = document.getElementById('calendarContainer');
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth(); 
    
    document.getElementById('currentMonthLabel').innerText = `${year}年 ${month + 1}月`;
    container.innerHTML = '';

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // 空白填充
    for (let i = 0; i < firstDay; i++) {
      container.innerHTML += `<div class="calendar-day status-gray"></div>`;
    }

    // 日期填充
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      
      // 熱點計算邏輯
      const dayCapacity = CONFIG.totalSlotsPerDay * CONFIG.maxPerSlot;
      const currentCount = allBookings.filter(b => b.date === dateStr).length;
      const percent = currentCount / dayCapacity;

      let colorClass = 'status-green'; // 默認綠色
      let statusText = '空閒';

      if (percent >= 0.9) {
        colorClass = 'status-red';
        statusText = '已滿';
      } else if (percent >= 0.5) {
        colorClass = 'status-yellow';
        statusText = '繁忙';
      }

      const dayDiv = document.createElement('div');
      dayDiv.className = `calendar-day ${colorClass}`;
      // 如果已選日期是今天，保持選中狀態
      if(selectedDate === dateStr) dayDiv.classList.add('selected');
      
      dayDiv.onclick = () => selectDate(dayDiv, dateStr);
      dayDiv.innerHTML = `
        <div class="fw-bold">${day}</div>
        <div style="font-size:0.7em;">${statusText}</div>
      `;
      container.appendChild(dayDiv);
    }
  }

  function selectDate(element, dateStr) {
    document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');

    selectedDate = dateStr;
    document.getElementById('selectedDateDisplay').innerText = dateStr;
    document.getElementById('bookingSection').style.display = 'flex';
    
    // 重置表單
    selectedTime = null;
    document.getElementById('displayTime').value = '';
    document.getElementById('submitBtn').disabled = true;
    
    renderSlots(dateStr);
  }

  // --- 2. 繪製時段 ---
  function renderSlots(date) {
    const container = document.getElementById('slotsContainer');
    container.innerHTML = '';

    CONFIG.timeSlots.forEach(time => {
      const count = allBookings.filter(b => b.date === date && b.time === time).length;
      const isFull = count >= CONFIG.maxPerSlot;
      const remaining = CONFIG.maxPerSlot - count;

      const div = document.createElement('div');
      div.className = 'col-6';
      div.innerHTML = `
        <div class="slot-card p-2 text-center rounded ${isFull ? 'disabled' : ''} ${selectedTime === time ? 'active' : ''}" 
             onclick="selectTime(this, '${time}')">
          <div class="fw-bold">${time}</div>
          <small style="font-size:0.8em;">${isFull ? '已額滿' : '餘 ' + remaining + ' 組'}</small>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function selectTime(element, time) {
    if (element.classList.contains('disabled')) return;

    document.querySelectorAll('.slot-card').forEach(el => el.classList.remove('active'));
    element.classList.add('active'); // 只加到內層

    selectedTime = time;
    document.getElementById('displayTime').value = `${selectedDate} ${selectedTime}`;
    document.getElementById('submitBtn').disabled = false;
  }

  // --- 3. 提交預約 ---
  function submitBooking() {
    const bookerId = document.getElementById('bookerId').value;
    if (!bookerId) return;

    // 顯示 Loading
    const btn = document.getElementById('submitBtn');
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "處理中...";
    document.getElementById('loader').style.display = 'flex';

    google.script.run
      .withSuccessHandler(function(response) {
        document.getElementById('loader').style.display = 'none';
        btn.innerText = originalText;
        btn.disabled = false;

        if (response.success) {
          alert(`✅ 預約成功！\n\n預約號碼: ${response.bookingRef}\n請截圖保存。`);
          // 成功後，重整資料以顯示最新狀態
          selectedDate = null;
          selectedTime = null;
          document.getElementById('bookingSection').style.display = 'none';
          document.getElementById('bookingForm').reset();
          refreshData(); 
        } else {
          alert("❌ 預約失敗: " + response.message);
          refreshData(); // 重新整理，因為可能剛剛被人搶先了
        }
      })
      .withFailureHandler(function(err) {
        document.getElementById('loader').style.display = 'none';
        alert("系統錯誤: " + err);
        btn.disabled = false;
        btn.innerText = originalText;
      })
      .handleBooking(selectedDate, selectedTime, bookerId);
  }
</script>
</body>
</html>
