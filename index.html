<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç´„ç³»çµ± V2 (ç†±é»æ—¥æ›†ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* æ—¥æ›†æ¨£å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { 
            border: 1px solid #ddd; padding: 10px; min-height: 80px; cursor: pointer; position: relative; border-radius: 8px;
        }
        .calendar-day:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .calendar-day.selected { border: 2px solid #0d6efd; transform: scale(1.05); }
        .cal-date { font-weight: bold; font-size: 1.1em; }
        .cal-status { font-size: 0.8em; margin-top: 5px; }
        
        /* ç‹€æ…‹é¡è‰² */
        .status-green { background-color: #d1e7dd; color: #0f5132; } /* ç©ºé–’ */
        .status-yellow { background-color: #fff3cd; color: #664d03; } /* ä¸€åŠæ»¿ */
        .status-red { background-color: #f8d7da; color: #842029; }   /* çˆ†æ»¿ */
        .status-gray { background-color: #f8f9fa; color: #aaa; pointer-events: none; } /* éæœ¬æœˆæˆ–éå» */

        /* æ™‚æ®µå¡ç‰‡ */
        .slot-card { cursor: pointer; border: 1px solid #ddd; transition: 0.2s; }
        .slot-card:hover { background-color: #f0f8ff; }
        .slot-card.active { background-color: #0d6efd; color: white; }
        .slot-card.disabled { background-color: #e9ecef; color: #999; pointer-events: none; }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4">é ç´„ç³»çµ± (æ—¥æ›†ç†±é»ç‰ˆ)</h2>

    <div class="row mb-4">
        <div class="col-md-6 offset-md-3">
            <div class="input-group">
                <input type="file" id="uploadExcel" class="form-control" accept=".xlsx, .xls">
                <span class="input-group-text bg-light">ğŸ“‚ è¼‰å…¥ Excel æ•¸æ“š</span>
            </div>
            <div id="loadingStatus" class="form-text text-center mt-2">è«‹å…ˆä¸Šå‚³ Excel ä»¥è®€å–ä½”ç”¨æƒ…æ³</div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span id="currentMonthLabel" class="h5 mb-0">æœˆä»½</span>
            <div>
                <span class="badge bg-success me-1">ç¶ : ç©ºé–’</span>
                <span class="badge bg-warning text-dark me-1">é»ƒ: ç¹å¿™</span>
                <span class="badge bg-danger">ç´…: å·²æ»¿</span>
            </div>
        </div>
        <div class="card-body">
            <div class="calendar-grid mb-2 text-center fw-bold text-muted">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div id="calendarContainer" class="calendar-grid"></div>
        </div>
    </div>

    <div id="bookingSection" class="row" style="display:none;">
        <div class="col-md-7">
            <div class="card h-100">
                <div class="card-header">é¸æ“‡æ™‚æ®µ (<span id="selectedDateDisplay"></span>)</div>
                <div class="card-body">
                    <div id="slotsContainer" class="row g-2"></div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white">ç¢ºèªé ç´„</div>
                <div class="card-body">
                    <form id="bookingForm" onsubmit="event.preventDefault(); submitBooking();">
                        <div class="mb-3">
                            <label class="form-label">å·²é¸æ™‚æ®µ</label>
                            <input type="text" class="form-control" id="displayTime" disabled readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é ç´„äººè™Ÿç¢¼ / ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="bookerId" placeholder="è«‹è¼¸å…¥æœƒå“¡ç·¨è™Ÿæˆ–é›»è©±" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">ç¢ºèªä¸¦ç”Ÿæˆé ç´„è™Ÿç¢¼</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ç³»çµ±è¨­å®š ---
    const CONFIG = {
        maxPerSlot: 3,
        // å®šç¾©æ¯ä¸€å¤©çš„ç¸½æ™‚æ®µæ•¸ (ç”¨æ–¼è¨ˆç®—æ—¥æ›†é¡è‰²)
        // 9, 10, 11, 12 (4å€‹) + 14, 15, 16 (3å€‹) = å…± 7 å€‹æ™‚æ®µ
        totalSlotsPerDay: 7, 
        timeSlots: ["09:00", "10:00", "11:00", "12:00", "14:00", "15:00", "16:00"]
    };

    let existingBookings = []; 
    let selectedDate = null;
    let selectedTime = null;

    // --- 1. Excel è®€å– ---
    document.getElementById('uploadExcel').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            existingBookings = jsonData.map(row => ({
                date: parseExcelDate(row['Date']), // éœ€ç¢ºä¿ Excel æ¬„ä½åç¨±æ­£ç¢º
                time: row['Time']
            }));

            document.getElementById('loadingStatus').innerHTML = `<span class="text-success">âœ… å·²è¼‰å…¥ ${existingBookings.length} ç­†é ç´„ï¼Œè«‹é¸æ“‡æ—¥æœŸ</span>`;
            renderCalendar(); // è®€å–å®Œç•¢å¾Œç¹ªè£½æ—¥æ›†
        };
        reader.readAsArrayBuffer(file);
    });

    // --- 2. æ—¥æ›†é‚è¼¯ ---
    function renderCalendar() {
        const container = document.getElementById('calendarContainer');
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth(); // 0-11
        
        document.getElementById('currentMonthLabel').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        container.innerHTML = '';

        // è¨ˆç®—è©²æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // å¡«å……ç©ºç™½å¤©æ•¸
        for (let i = 0; i < firstDay; i++) {
            container.innerHTML += `<div class="calendar-day status-gray"></div>`;
        }

        // å¡«å……æ—¥æœŸ
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            // è¨ˆç®—ç•¶å¤©ç¹å¿™ç¨‹åº¦
            // è©²æ—¥æœ€å¤§å®¹é‡ = æ¯å¤©7å€‹æ™‚æ®µ * æ¯å€‹æ™‚æ®µ3çµ„ = 21çµ„
            const dayCapacity = CONFIG.totalSlotsPerDay * CONFIG.maxPerSlot;
            const currentBookings = existingBookings.filter(b => b.date === dateStr).length;
            const usagePercent = currentBookings / dayCapacity;

            let colorClass = 'status-green';
            let statusText = 'ç©ºé–’';

            if (usagePercent >= 0.9) {
                colorClass = 'status-red';
                statusText = 'å·²æ»¿';
            } else if (usagePercent >= 0.5) {
                colorClass = 'status-yellow';
                statusText = 'ç¹å¿™';
            }

            // æ§‹å»º HTML
            const dayDiv = document.createElement('div');
            dayDiv.className = `calendar-day ${colorClass}`;
            dayDiv.onclick = () => selectDate(dayDiv, dateStr);
            dayDiv.innerHTML = `
                <div class="cal-date">${day}</div>
                <div class="cal-status">${statusText}</div>
                <small class="text-muted" style="font-size:0.7em;">(${currentBookings}/${dayCapacity})</small>
            `;
            container.appendChild(dayDiv);
        }
    }

    function selectDate(element, dateStr) {
        // æ¨£å¼åˆ‡æ›
        document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');

        selectedDate = dateStr;
        document.getElementById('selectedDateDisplay').innerText = dateStr;
        document.getElementById('bookingSection').style.display = 'flex';
        document.getElementById('displayTime').value = ''; 
        document.getElementById('bookerId').value = '';
        renderSlots(dateStr);
    }

    // --- 3. æ™‚æ®µé¡¯ç¤ºé‚è¼¯ ---
    function renderSlots(date) {
        const container = document.getElementById('slotsContainer');
        container.innerHTML = '';

        CONFIG.timeSlots.forEach(time => {
            const count = existingBookings.filter(b => b.date === date && b.time === time).length;
            const isFull = count >= CONFIG.maxPerSlot;
            const remaining = CONFIG.maxPerSlot - count;

            const div = document.createElement('div');
            div.className = 'col-6 col-md-4';
            div.innerHTML = `
                <div class="slot-card p-2 text-center rounded ${isFull ? 'disabled' : ''}" 
                     onclick="selectTime(this, '${time}')">
                    <div class="fw-bold">${time}</div>
                    <small>${isFull ? 'é¡æ»¿' : 'é¤˜ ' + remaining}</small>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function selectTime(element, time) {
        if (element.classList.contains('disabled')) return;
        
        document.querySelectorAll('.slot-card').forEach(el => el.classList.remove('active'));
        element.classList.add('active'); // é¸ä¸­æ•ˆæœè£¡é¢é€™å±¤ div
        
        selectedTime = time;
        document.getElementById('displayTime').value = `${selectedDate} @ ${selectedTime}`;
    }

    // --- 4. æäº¤èˆ‡ç”Ÿæˆè™Ÿç¢¼ ---
    function submitBooking() {
        if (!selectedDate || !selectedTime) {
            alert('è«‹å…ˆé¸æ“‡æ—¥æœŸèˆ‡æ™‚æ®µï¼');
            return;
        }

        const bookerId = document.getElementById('bookerId').value;
        
        // ç”Ÿæˆå”¯ä¸€é ç´„è™Ÿç¢¼é‚è¼¯ï¼šBK + æ—¥æœŸ + æ™‚é–“(å»é™¤å†’è™Ÿ) + éš¨æ©Ÿ4ç¢¼
        // ä¾‹å¦‚ï¼šBK-20231025-0900-X7Z9
        const randomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
        const cleanDate = selectedDate.replace(/-/g, '');
        const cleanTime = selectedTime.replace(':', '');
        const bookingRef = `BK-${cleanDate}-${cleanTime}-${randomCode}`;

        // é¡¯ç¤ºçµæœ
        const message = `
            ğŸ‰ é ç´„æˆåŠŸï¼
            ---------------------------
            é ç´„è™Ÿç¢¼ï¼š${bookingRef}
            é ç´„äººIDï¼š${bookerId}
            æ™‚é–“ï¼š${selectedDate} ${selectedTime}
            ---------------------------
            è«‹æˆªåœ–ä¿å­˜æ­¤ç•«é¢ã€‚
        `;
        alert(message);

        // å¯ä»¥åœ¨é€™è£¡å¯«ä»£ç¢¼å°‡é€™å€‹æ–°çš„ booking æš«å­˜åˆ° existingBookings é™£åˆ—ï¼Œè®“ç•«é¢å³æ™‚æ›´æ–°
        existingBookings.push({ date: selectedDate, time: selectedTime });
        renderCalendar(); // åˆ·æ–°æ—¥æ›†é¡è‰²
        renderSlots(selectedDate); // åˆ·æ–°æ™‚æ®µç‹€æ…‹
    }

    // å·¥å…·ï¼šæ—¥æœŸè½‰æ›
    function parseExcelDate(dateVal) {
        if (!dateVal) return "";
        if (typeof dateVal === 'string') return dateVal;
        const date = new Date((dateVal - (25567 + 2)) * 86400 * 1000);
        return date.toISOString().split('T')[0];
    }
</script>

</body>
</html><!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç´„ç³»çµ± V2 (ç†±é»æ—¥æ›†ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* æ—¥æ›†æ¨£å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { 
            border: 1px solid #ddd; padding: 10px; min-height: 80px; cursor: pointer; position: relative; border-radius: 8px;
        }
        .calendar-day:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .calendar-day.selected { border: 2px solid #0d6efd; transform: scale(1.05); }
        .cal-date { font-weight: bold; font-size: 1.1em; }
        .cal-status { font-size: 0.8em; margin-top: 5px; }
        
        /* ç‹€æ…‹é¡è‰² */
        .status-green { background-color: #d1e7dd; color: #0f5132; } /* ç©ºé–’ */
        .status-yellow { background-color: #fff3cd; color: #664d03; } /* ä¸€åŠæ»¿ */
        .status-red { background-color: #f8d7da; color: #842029; }   /* çˆ†æ»¿ */
        .status-gray { background-color: #f8f9fa; color: #aaa; pointer-events: none; } /* éæœ¬æœˆæˆ–éå» */

        /* æ™‚æ®µå¡ç‰‡ */
        .slot-card { cursor: pointer; border: 1px solid #ddd; transition: 0.2s; }
        .slot-card:hover { background-color: #f0f8ff; }
        .slot-card.active { background-color: #0d6efd; color: white; }
        .slot-card.disabled { background-color: #e9ecef; color: #999; pointer-events: none; }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4">é ç´„ç³»çµ± (æ—¥æ›†ç†±é»ç‰ˆ)</h2>

    <div class="row mb-4">
        <div class="col-md-6 offset-md-3">
            <div class="input-group">
                <input type="file" id="uploadExcel" class="form-control" accept=".xlsx, .xls">
                <span class="input-group-text bg-light">ğŸ“‚ è¼‰å…¥ Excel æ•¸æ“š</span>
            </div>
            <div id="loadingStatus" class="form-text text-center mt-2">è«‹å…ˆä¸Šå‚³ Excel ä»¥è®€å–ä½”ç”¨æƒ…æ³</div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span id="currentMonthLabel" class="h5 mb-0">æœˆä»½</span>
            <div>
                <span class="badge bg-success me-1">ç¶ : ç©ºé–’</span>
                <span class="badge bg-warning text-dark me-1">é»ƒ: ç¹å¿™</span>
                <span class="badge bg-danger">ç´…: å·²æ»¿</span>
            </div>
        </div>
        <div class="card-body">
            <div class="calendar-grid mb-2 text-center fw-bold text-muted">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div id="calendarContainer" class="calendar-grid"></div>
        </div>
    </div>

    <div id="bookingSection" class="row" style="display:none;">
        <div class="col-md-7">
            <div class="card h-100">
                <div class="card-header">é¸æ“‡æ™‚æ®µ (<span id="selectedDateDisplay"></span>)</div>
                <div class="card-body">
                    <div id="slotsContainer" class="row g-2"></div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white">ç¢ºèªé ç´„</div>
                <div class="card-body">
                    <form id="bookingForm" onsubmit="event.preventDefault(); submitBooking();">
                        <div class="mb-3">
                            <label class="form-label">å·²é¸æ™‚æ®µ</label>
                            <input type="text" class="form-control" id="displayTime" disabled readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é ç´„äººè™Ÿç¢¼ / ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="bookerId" placeholder="è«‹è¼¸å…¥æœƒå“¡ç·¨è™Ÿæˆ–é›»è©±" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">ç¢ºèªä¸¦ç”Ÿæˆé ç´„è™Ÿç¢¼</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ç³»çµ±è¨­å®š ---
    const CONFIG = {
        maxPerSlot: 3,
        // å®šç¾©æ¯ä¸€å¤©çš„ç¸½æ™‚æ®µæ•¸ (ç”¨æ–¼è¨ˆç®—æ—¥æ›†é¡è‰²)
        // 9, 10, 11, 12 (4å€‹) + 14, 15, 16 (3å€‹) = å…± 7 å€‹æ™‚æ®µ
        totalSlotsPerDay: 7, 
        timeSlots: ["09:00", "10:00", "11:00", "12:00", "14:00", "15:00", "16:00"]
    };

    let existingBookings = []; 
    let selectedDate = null;
    let selectedTime = null;

    // --- 1. Excel è®€å– ---
    document.getElementById('uploadExcel').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            existingBookings = jsonData.map(row => ({
                date: parseExcelDate(row['Date']), // éœ€ç¢ºä¿ Excel æ¬„ä½åç¨±æ­£ç¢º
                time: row['Time']
            }));

            document.getElementById('loadingStatus').innerHTML = `<span class="text-success">âœ… å·²è¼‰å…¥ ${existingBookings.length} ç­†é ç´„ï¼Œè«‹é¸æ“‡æ—¥æœŸ</span>`;
            renderCalendar(); // è®€å–å®Œç•¢å¾Œç¹ªè£½æ—¥æ›†
        };
        reader.readAsArrayBuffer(file);
    });

    // --- 2. æ—¥æ›†é‚è¼¯ ---
    function renderCalendar() {
        const container = document.getElementById('calendarContainer');
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth(); // 0-11
        
        document.getElementById('currentMonthLabel').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        container.innerHTML = '';

        // è¨ˆç®—è©²æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // å¡«å……ç©ºç™½å¤©æ•¸
        for (let i = 0; i < firstDay; i++) {
            container.innerHTML += `<div class="calendar-day status-gray"></div>`;
        }

        // å¡«å……æ—¥æœŸ
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            // è¨ˆç®—ç•¶å¤©ç¹å¿™ç¨‹åº¦
            // è©²æ—¥æœ€å¤§å®¹é‡ = æ¯å¤©7å€‹æ™‚æ®µ * æ¯å€‹æ™‚æ®µ3çµ„ = 21çµ„
            const dayCapacity = CONFIG.totalSlotsPerDay * CONFIG.maxPerSlot;
            const currentBookings = existingBookings.filter(b => b.date === dateStr).length;
            const usagePercent = currentBookings / dayCapacity;

            let colorClass = 'status-green';
            let statusText = 'ç©ºé–’';

            if (usagePercent >= 0.9) {
                colorClass = 'status-red';
                statusText = 'å·²æ»¿';
            } else if (usagePercent >= 0.5) {
                colorClass = 'status-yellow';
                statusText = 'ç¹å¿™';
            }

            // æ§‹å»º HTML
            const dayDiv = document.createElement('div');
            dayDiv.className = `calendar-day ${colorClass}`;
            dayDiv.onclick = () => selectDate(dayDiv, dateStr);
            dayDiv.innerHTML = `
                <div class="cal-date">${day}</div>
                <div class="cal-status">${statusText}</div>
                <small class="text-muted" style="font-size:0.7em;">(${currentBookings}/${dayCapacity})</small>
            `;
            container.appendChild(dayDiv);
        }
    }

    function selectDate(element, dateStr) {
        // æ¨£å¼åˆ‡æ›
        document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');

        selectedDate = dateStr;
        document.getElementById('selectedDateDisplay').innerText = dateStr;
        document.getElementById('bookingSection').style.display = 'flex';
        document.getElementById('displayTime').value = ''; 
        document.getElementById('bookerId').value = '';
        renderSlots(dateStr);
    }

    // --- 3. æ™‚æ®µé¡¯ç¤ºé‚è¼¯ ---
    function renderSlots(date) {
        const container = document.getElementById('slotsContainer');
        container.innerHTML = '';

        CONFIG.timeSlots.forEach(time => {
            const count = existingBookings.filter(b => b.date === date && b.time === time).length;
            const isFull = count >= CONFIG.maxPerSlot;
            const remaining = CONFIG.maxPerSlot - count;

            const div = document.createElement('div');
            div.className = 'col-6 col-md-4';
            div.innerHTML = `
                <div class="slot-card p-2 text-center rounded ${isFull ? 'disabled' : ''}" 
                     onclick="selectTime(this, '${time}')">
                    <div class="fw-bold">${time}</div>
                    <small>${isFull ? 'é¡æ»¿' : 'é¤˜ ' + remaining}</small>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function selectTime(element, time) {
        if (element.classList.contains('disabled')) return;
        
        document.querySelectorAll('.slot-card').forEach(el => el.classList.remove('active'));
        element.classList.add('active'); // é¸ä¸­æ•ˆæœè£¡é¢é€™å±¤ div
        
        selectedTime = time;
        document.getElementById('displayTime').value = `${selectedDate} @ ${selectedTime}`;
    }

    // --- 4. æäº¤èˆ‡ç”Ÿæˆè™Ÿç¢¼ ---
    function submitBooking() {
        if (!selectedDate || !selectedTime) {
            alert('è«‹å…ˆé¸æ“‡æ—¥æœŸèˆ‡æ™‚æ®µï¼');
            return;
        }

        const bookerId = document.getElementById('bookerId').value;
        
        // ç”Ÿæˆå”¯ä¸€é ç´„è™Ÿç¢¼é‚è¼¯ï¼šBK + æ—¥æœŸ + æ™‚é–“(å»é™¤å†’è™Ÿ) + éš¨æ©Ÿ4ç¢¼
        // ä¾‹å¦‚ï¼šBK-20231025-0900-X7Z9
        const randomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
        const cleanDate = selectedDate.replace(/-/g, '');
        const cleanTime = selectedTime.replace(':', '');
        const bookingRef = `BK-${cleanDate}-${cleanTime}-${randomCode}`;

        // é¡¯ç¤ºçµæœ
        const message = `
            ğŸ‰ é ç´„æˆåŠŸï¼
            ---------------------------
            é ç´„è™Ÿç¢¼ï¼š${bookingRef}
            é ç´„äººIDï¼š${bookerId}
            æ™‚é–“ï¼š${selectedDate} ${selectedTime}
            ---------------------------
            è«‹æˆªåœ–ä¿å­˜æ­¤ç•«é¢ã€‚
        `;
        alert(message);

        // å¯ä»¥åœ¨é€™è£¡å¯«ä»£ç¢¼å°‡é€™å€‹æ–°çš„ booking æš«å­˜åˆ° existingBookings é™£åˆ—ï¼Œè®“ç•«é¢å³æ™‚æ›´æ–°
        existingBookings.push({ date: selectedDate, time: selectedTime });
        renderCalendar(); // åˆ·æ–°æ—¥æ›†é¡è‰²
        renderSlots(selectedDate); // åˆ·æ–°æ™‚æ®µç‹€æ…‹
    }

    // å·¥å…·ï¼šæ—¥æœŸè½‰æ›
    function parseExcelDate(dateVal) {
        if (!dateVal) return "";
        if (typeof dateVal === 'string') return dateVal;
        const date = new Date((dateVal - (25567 + 2)) * 86400 * 1000);
        return date.toISOString().split('T')[0];
    }
</script>

</body>
</html><!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç´„ç³»çµ± V2 (ç†±é»æ—¥æ›†ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* æ—¥æ›†æ¨£å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { 
            border: 1px solid #ddd; padding: 10px; min-height: 80px; cursor: pointer; position: relative; border-radius: 8px;
        }
        .calendar-day:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .calendar-day.selected { border: 2px solid #0d6efd; transform: scale(1.05); }
        .cal-date { font-weight: bold; font-size: 1.1em; }
        .cal-status { font-size: 0.8em; margin-top: 5px; }
        
        /* ç‹€æ…‹é¡è‰² */
        .status-green { background-color: #d1e7dd; color: #0f5132; } /* ç©ºé–’ */
        .status-yellow { background-color: #fff3cd; color: #664d03; } /* ä¸€åŠæ»¿ */
        .status-red { background-color: #f8d7da; color: #842029; }   /* çˆ†æ»¿ */
        .status-gray { background-color: #f8f9fa; color: #aaa; pointer-events: none; } /* éæœ¬æœˆæˆ–éå» */

        /* æ™‚æ®µå¡ç‰‡ */
        .slot-card { cursor: pointer; border: 1px solid #ddd; transition: 0.2s; }
        .slot-card:hover { background-color: #f0f8ff; }
        .slot-card.active { background-color: #0d6efd; color: white; }
        .slot-card.disabled { background-color: #e9ecef; color: #999; pointer-events: none; }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4">é ç´„ç³»çµ± (æ—¥æ›†ç†±é»ç‰ˆ)</h2>

    <div class="row mb-4">
        <div class="col-md-6 offset-md-3">
            <div class="input-group">
                <input type="file" id="uploadExcel" class="form-control" accept=".xlsx, .xls">
                <span class="input-group-text bg-light">ğŸ“‚ è¼‰å…¥ Excel æ•¸æ“š</span>
            </div>
            <div id="loadingStatus" class="form-text text-center mt-2">è«‹å…ˆä¸Šå‚³ Excel ä»¥è®€å–ä½”ç”¨æƒ…æ³</div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span id="currentMonthLabel" class="h5 mb-0">æœˆä»½</span>
            <div>
                <span class="badge bg-success me-1">ç¶ : ç©ºé–’</span>
                <span class="badge bg-warning text-dark me-1">é»ƒ: ç¹å¿™</span>
                <span class="badge bg-danger">ç´…: å·²æ»¿</span>
            </div>
        </div>
        <div class="card-body">
            <div class="calendar-grid mb-2 text-center fw-bold text-muted">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div id="calendarContainer" class="calendar-grid"></div>
        </div>
    </div>

    <div id="bookingSection" class="row" style="display:none;">
        <div class="col-md-7">
            <div class="card h-100">
                <div class="card-header">é¸æ“‡æ™‚æ®µ (<span id="selectedDateDisplay"></span>)</div>
                <div class="card-body">
                    <div id="slotsContainer" class="row g-2"></div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white">ç¢ºèªé ç´„</div>
                <div class="card-body">
                    <form id="bookingForm" onsubmit="event.preventDefault(); submitBooking();">
                        <div class="mb-3">
                            <label class="form-label">å·²é¸æ™‚æ®µ</label>
                            <input type="text" class="form-control" id="displayTime" disabled readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é ç´„äººè™Ÿç¢¼ / ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="bookerId" placeholder="è«‹è¼¸å…¥æœƒå“¡ç·¨è™Ÿæˆ–é›»è©±" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">ç¢ºèªä¸¦ç”Ÿæˆé ç´„è™Ÿç¢¼</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ç³»çµ±è¨­å®š ---
    const CONFIG = {
        maxPerSlot: 3,
        // å®šç¾©æ¯ä¸€å¤©çš„ç¸½æ™‚æ®µæ•¸ (ç”¨æ–¼è¨ˆç®—æ—¥æ›†é¡è‰²)
        // 9, 10, 11, 12 (4å€‹) + 14, 15, 16 (3å€‹) = å…± 7 å€‹æ™‚æ®µ
        totalSlotsPerDay: 7, 
        timeSlots: ["09:00", "10:00", "11:00", "12:00", "14:00", "15:00", "16:00"]
    };

    let existingBookings = []; 
    let selectedDate = null;
    let selectedTime = null;

    // --- 1. Excel è®€å– ---
    document.getElementById('uploadExcel').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            existingBookings = jsonData.map(row => ({
                date: parseExcelDate(row['Date']), // éœ€ç¢ºä¿ Excel æ¬„ä½åç¨±æ­£ç¢º
                time: row['Time']
            }));

            document.getElementById('loadingStatus').innerHTML = `<span class="text-success">âœ… å·²è¼‰å…¥ ${existingBookings.length} ç­†é ç´„ï¼Œè«‹é¸æ“‡æ—¥æœŸ</span>`;
            renderCalendar(); // è®€å–å®Œç•¢å¾Œç¹ªè£½æ—¥æ›†
        };
        reader.readAsArrayBuffer(file);
    });

    // --- 2. æ—¥æ›†é‚è¼¯ ---
    function renderCalendar() {
        const container = document.getElementById('calendarContainer');
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth(); // 0-11
        
        document.getElementById('currentMonthLabel').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        container.innerHTML = '';

        // è¨ˆç®—è©²æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // å¡«å……ç©ºç™½å¤©æ•¸
        for (let i = 0; i < firstDay; i++) {
            container.innerHTML += `<div class="calendar-day status-gray"></div>`;
        }

        // å¡«å……æ—¥æœŸ
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            // è¨ˆç®—ç•¶å¤©ç¹å¿™ç¨‹åº¦
            // è©²æ—¥æœ€å¤§å®¹é‡ = æ¯å¤©7å€‹æ™‚æ®µ * æ¯å€‹æ™‚æ®µ3çµ„ = 21çµ„
            const dayCapacity = CONFIG.totalSlotsPerDay * CONFIG.maxPerSlot;
            const currentBookings = existingBookings.filter(b => b.date === dateStr).length;
            const usagePercent = currentBookings / dayCapacity;

            let colorClass = 'status-green';
            let statusText = 'ç©ºé–’';

            if (usagePercent >= 0.9) {
                colorClass = 'status-red';
                statusText = 'å·²æ»¿';
            } else if (usagePercent >= 0.5) {
                colorClass = 'status-yellow';
                statusText = 'ç¹å¿™';
            }

            // æ§‹å»º HTML
            const dayDiv = document.createElement('div');
            dayDiv.className = `calendar-day ${colorClass}`;
            dayDiv.onclick = () => selectDate(dayDiv, dateStr);
            dayDiv.innerHTML = `
                <div class="cal-date">${day}</div>
                <div class="cal-status">${statusText}</div>
                <small class="text-muted" style="font-size:0.7em;">(${currentBookings}/${dayCapacity})</small>
            `;
            container.appendChild(dayDiv);
        }
    }

    function selectDate(element, dateStr) {
        // æ¨£å¼åˆ‡æ›
        document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');

        selectedDate = dateStr;
        document.getElementById('selectedDateDisplay').innerText = dateStr;
        document.getElementById('bookingSection').style.display = 'flex';
        document.getElementById('displayTime').value = ''; 
        document.getElementById('bookerId').value = '';
        renderSlots(dateStr);
    }

    // --- 3. æ™‚æ®µé¡¯ç¤ºé‚è¼¯ ---
    function renderSlots(date) {
        const container = document.getElementById('slotsContainer');
        container.innerHTML = '';

        CONFIG.timeSlots.forEach(time => {
            const count = existingBookings.filter(b => b.date === date && b.time === time).length;
            const isFull = count >= CONFIG.maxPerSlot;
            const remaining = CONFIG.maxPerSlot - count;

            const div = document.createElement('div');
            div.className = 'col-6 col-md-4';
            div.innerHTML = `
                <div class="slot-card p-2 text-center rounded ${isFull ? 'disabled' : ''}" 
                     onclick="selectTime(this, '${time}')">
                    <div class="fw-bold">${time}</div>
                    <small>${isFull ? 'é¡æ»¿' : 'é¤˜ ' + remaining}</small>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function selectTime(element, time) {
        if (element.classList.contains('disabled')) return;
        
        document.querySelectorAll('.slot-card').forEach(el => el.classList.remove('active'));
        element.classList.add('active'); // é¸ä¸­æ•ˆæœè£¡é¢é€™å±¤ div
        
        selectedTime = time;
        document.getElementById('displayTime').value = `${selectedDate} @ ${selectedTime}`;
    }

    // --- 4. æäº¤èˆ‡ç”Ÿæˆè™Ÿç¢¼ ---
    function submitBooking() {
        if (!selectedDate || !selectedTime) {
            alert('è«‹å…ˆé¸æ“‡æ—¥æœŸèˆ‡æ™‚æ®µï¼');
            return;
        }

        const bookerId = document.getElementById('bookerId').value;
        
        // ç”Ÿæˆå”¯ä¸€é ç´„è™Ÿç¢¼é‚è¼¯ï¼šBK + æ—¥æœŸ + æ™‚é–“(å»é™¤å†’è™Ÿ) + éš¨æ©Ÿ4ç¢¼
        // ä¾‹å¦‚ï¼šBK-20231025-0900-X7Z9
        const randomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
        const cleanDate = selectedDate.replace(/-/g, '');
        const cleanTime = selectedTime.replace(':', '');
        const bookingRef = `BK-${cleanDate}-${cleanTime}-${randomCode}`;

        // é¡¯ç¤ºçµæœ
        const message = `
            ğŸ‰ é ç´„æˆåŠŸï¼
            ---------------------------
            é ç´„è™Ÿç¢¼ï¼š${bookingRef}
            é ç´„äººIDï¼š${bookerId}
            æ™‚é–“ï¼š${selectedDate} ${selectedTime}
            ---------------------------
            è«‹æˆªåœ–ä¿å­˜æ­¤ç•«é¢ã€‚
        `;
        alert(message);

        // å¯ä»¥åœ¨é€™è£¡å¯«ä»£ç¢¼å°‡é€™å€‹æ–°çš„ booking æš«å­˜åˆ° existingBookings é™£åˆ—ï¼Œè®“ç•«é¢å³æ™‚æ›´æ–°
        existingBookings.push({ date: selectedDate, time: selectedTime });
        renderCalendar(); // åˆ·æ–°æ—¥æ›†é¡è‰²
        renderSlots(selectedDate); // åˆ·æ–°æ™‚æ®µç‹€æ…‹
    }

    // å·¥å…·ï¼šæ—¥æœŸè½‰æ›
    function parseExcelDate(dateVal) {
        if (!dateVal) return "";
        if (typeof dateVal === 'string') return dateVal;
        const date = new Date((dateVal - (25567 + 2)) * 86400 * 1000);
        return date.toISOString().split('T')[0];
    }
</script>

</body>
</html>
